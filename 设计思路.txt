文献阅读智能体项目
技术设计说明文档 V3.0
1.0 引言
1.1 文档目的
本文档旨在提供一个清晰、可执行的技术设计方案。文档将详细阐述系统的核心架构、关键模块的具体实现思路，包括会话状态管理、上下文隔离策略以及数据持久化方案。
2.0 系统架构
系统采用前后端分离的架构。前端负责用户界面、用户身份管理和API请求。后端作为核心“编排器”（Orchestrator），负责实现所有业务逻辑，包括智能体的调用、流程控制和数据存储，不依赖任何现有的Agent框架。
3.0 具体模块设计
3.1 用户与会话管理
3.1.1 用户身份识别：
- 前端：在用户首次访问时，通过一个简单的UI界面，引导用户输入一个自定义的文本标识符（user_id）。该user_id将被存储在浏览器的localStorage中，以实现持久化登录。后续所有对后端的API请求，前端都必须附带此user_id。
- 后端：后端将从API请求中接收user_id，并将其作为数据库查询的主要索引，用以隔离不同用户的数据。
3.1.2 会话生命周期：
- 当用户上传一篇新文献时，后端将创建一个新的会话实例。
- 一个会话实例必须包含一个全局唯一的session_id，并与上传该文献的user_id进行绑定。
- 前端负责管理用户的多个会话。用户的会话列表（包含session_id和文献标题）将通过API从后端获取，并在UI（如侧边栏）上展示。用户通过点击UI元素来选择并激活一个特定的会话。当前激活的session_id将被存储在浏览器的sessionStorage中。
3.2 交互流程设计：有限状态机 (FSM)
为了精确控制复杂的交互流程，后端编排器将采用**有限状态机（Finite State Machine）**模型来管理每个会话的生命周期。每个会话对象都将包含一个current_state字段。
3.2.1 核心状态定义：
- GUIDE_PENDING_REPORT (等待导读)：会话的初始状态。在用户上传文献后进入此状态。触发“导读智能体”生成初步分析报告。完成后，状态转移至GUIDE_PENDING_PLAN。
- GUIDE_PENDING_PLAN (等待规划)：在系统给出导读报告和提问后进入此状态。等待用户输入兴趣点，并触发“导读智能体”生成个性化阅读路线。完成后，状态转移至CONTROL_ROUTING。
- CONTROL_ROUTING (主控路由)：会话的核心问答状态。在此状态下，接收到的用户问题将首先交由“主控智能体”进行意图分析和路由判断。
- （中间流程）：根据主控智能体的路由结果，系统将调用相应的功能智能体（如引言、方法等）来生成初步答案，并交由主控智能体进行审核。
- 状态循环：在回答完毕后，会话状态将保持在CONTROL_ROUTING，以准备接收用户的下一个问题。
3.3 上下文与历史记录设计：按需隔离
为平衡上下文完整性与API调用成本，系统将采用“按需上下文隔离”策略。
3.3.1 主历史列表：
- 每个会话都将维护一个唯一的、完整的chat_history列表，按时间顺序记录所有用户与系统的公开交互。此列表是上下文的“唯一真相来源”。
3.3.2 上下文包 (Context Package) 分发策略：
- 主控智能体（路由任务）：需要接收完整的chat_history。这是为了确保它能准确理解用户的指代、省略和上下文关联，从而做出正确的路由判断。此外，主控智能体还将根据完整历史，将用户的模糊问题“重写”为一个清晰、独立的clarified_question。
- 功能智能体（引言、方法、结果等）：不直接接收chat_history。它们只接收两个核心输入：1) 文献的相关文本片段（document_chunk）；2) 由主控智能体生成的clarified_question。这确保了功能智能体的任务足够聚焦，降低了Token消耗和被无关信息干扰的风险。
- 主控智能体（审核任务）：不接收chat_history。它只接收用户的原始问题、功能智能体生成的答案草稿以及对应的文献原文片段。它的任务是进行事实核查，判断答案是否忠于原文，而非参与对话。
3.4 数据库设计：SQLite
考虑到项目初期的Demo和测试性质，系统将采用轻量级的SQLite数据库进行数据持久化，以简化部署和维护。
3.4.1 数据表结构：
- 系统将只包含一张核心数据表：sessions。
3.4.2 sessions 表字段定义：
- session_id (TEXT, PRIMARY KEY): 全局唯一的会话ID。
- user_id (TEXT, NOT NULL): 关联的用户标识符。
- title (TEXT): 会话的标题（如文献名），用于在前端列表展示。
- current_state (TEXT, NOT NULL): 当前会话所处的有限状态机状态。
- session_data (TEXT): 一个JSON字符串，用于存储非结构化但重要的会话数据，包括完整的chat_history列表、个性化阅读路线reading_plan等。
- last_updated (TIMESTAMP): 会话最后更新时间，用于排序。